<!DOCTYPE html>
<html>
	<head>
		
		<!-- include jquery mobile -->
		<!--<link rel="stylesheet" href="jquery/jquery.mobile-1.3.1.min.css" />-->
		<script src="jquery/jquery-2.0.0.min.js"></script>
		<script src="jquery/jquery.mobile-1.3.1.min.js"></script>
        
		<!-- Include cordova. -->
		<script src="cordova-2.3.0.js"></script>
		
		<!-- Include cordova plugins -->
		<script src="cordova.force.js"></script>
		
		<!-- include forcetk.mobilesdk for REST transaction support -->
		<script src="forcetk.mobilesdk.js"></script>
		
		<script>
			// The version of the REST API you wish to use in your app.
			var apiVersion = "v28.0";
			
			var forcetkClient;
			var debugMode = true;
			var logToConsole = cordova.require("salesforce/util/logger").logToConsole;
			var userId;
			
			jQuery(document).ready(function() {
								   //Add event listeners and so forth here
								   logToConsole("onLoad: jquery ready");
								   document.addEventListener("deviceready", onDeviceReady,false);
								   
								   });
								   
								   // When this function is called, Cordova has been initialized and is ready to roll
								   function onDeviceReady() {
									   logToConsole("onDeviceReady: Cordova ready");
									   //Call getAuthCredentials to get the initial session credentials
									   cordova.require("salesforce/plugin/oauth").getAuthCredentials(salesforceSessionRefreshed, getAuthCredentialsError);
									   
									   //register to receive notifications when autoRefreshOnForeground refreshes the sfdc session
									   document.addEventListener("salesforceSessionRefresh",salesforceSessionRefreshed,false);
									   
									   var capture_Button = document.getElementById('captureButton');
									   capture_Button.disabled = false;
								   }
        
		
			function salesforceSessionRefreshed(creds) {
				logToConsole("salesforceSessionRefreshed");
				
				// Depending on how we come into this method, `creds` may be callback data from the auth
				// plugin, or an event fired from the plugin.  The data is different between the two.
				var credsData = creds;
				if (creds.data)  // Event sets the `data` object with the auth data.
					credsData = creds.data;
				
				userId = credsData.userId;
				
				forcetkClient = new forcetk.Client(credsData.clientId, credsData.loginUrl, null,
											   cordova.require("salesforce/plugin/oauth").forcetkRefresh);
											   forcetkClient.setSessionToken(credsData.accessToken, apiVersion, credsData.instanceUrl);
											   forcetkClient.setRefreshToken(credsData.refreshToken);
											   forcetkClient.setUserAgentString(credsData.userAgent);
			}
		
			function getAuthCredentialsError(error) {
				logToConsole("getAuthCredentialsError: " + error);
			}
		
		</script>
		
		<script type="text/javascript">
			function uploadAttachment(imageToUpload) {
				logToConsole("Start Upload Attachment");
				//forcetkClient.create("Demo_Object__c", {Name : "From Application"}, onUploadSuccess, onUploadError );
				forcetkClient.create("Attachment", {Name : "From Application", Body : imageToUpload, ContentType : "image", ParentId : "001b000000JJrrQ"}, onUploadSuccess, onUploadError );
			}
		
			function onUploadSuccess(response) {
				logToConsole("Upload Success");
			}
			
			function onUploadError(error) {
				logToConsole("onErrorSfdc: " + JSON.stringify(error));
				alert("Upload Failed");
			}
		
			/*  Open the device camera app */
			function capturePhoto()
			{
				logToConsole("Take Photo clicked")
				// navigator.camera.getPicture( cameraSuccess, cameraError, [ cameraOptions ] );
				navigator.camera.getPicture(getPhoto,
										onFail,
										{
										quality: 50,
										destinationType: Camera.DestinationType.DATA_URL, // Return image as base64 encoded string
										sourceType:Camera.PictureSourceType.CAMERA,
										targetWidth:120,  // Width in pixels to scale image. Aspect ratio is maintained. Required targetHeight.
										targetHeight:180  // Height in pixels to scale image. Aspect ratio is maintained. Required targetWidth.
										});
			}
		
			/* navigator.camera.getPicture success function */
			function getPhoto(imageData)
			{
				var cameraImage = document.getElementById('cameraImage');
				cameraImage.src = "data:image/jpeg;base64," + imageData;
				
				logToConsole("Camera Success, src: " + imageData);
				
				uploadAttachment(imageData);
			}
			/* navigator.camera.getPicture fail function */
			function onFail(message)
			{
				alert('Failed because: ' + message);
			}
		</script>
	</head>
	
	<body style = "text-align:center;background-color:#ccc;padding:0px;">
		<div>
			<h1 style = "margin-bottom:0px;">Sample Camera</h1>
			<button id="captureButton" style = "font-size:20px;width:200px;height:44px;margin-bottom:5px;" onclick="capturePhoto();" disabled>Take Picture</button>
			<br></br>
			<img style="width:120px;height:180px;background-color:#fff;" id="cameraImage" src="" />
		</div>
	</body>
</html>